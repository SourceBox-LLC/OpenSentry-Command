#!/bin/bash
# OpenSentry Command Center - Quick Setup Script
# Run: chmod +x setup.sh && ./setup.sh

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         OpenSentry Command Center - Quick Setup               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check for Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker not found. Please install Docker first:"
    echo "   curl -fsSL https://get.docker.com | sh"
    exit 1
fi

echo "âœ… Docker found"

# Check if .env exists
if [ -f .env ]; then
    echo "âœ… .env file already exists"
    read -p "   Overwrite with new settings? (y/N): " overwrite
    if [ "$overwrite" != "y" ] && [ "$overwrite" != "Y" ]; then
        echo "   Keeping existing .env"
        echo ""
        echo "ðŸš€ Starting Command Center..."
        docker compose up --build -d
        echo ""
        echo "âœ… Command Center is running!"
        echo "   Dashboard: http://localhost:5000"
        echo "   Logs: docker compose logs -f"
        exit 0
    fi
fi

echo ""
echo "ðŸ“ Let's configure your Command Center..."
echo ""

# Get username
read -p "Choose a username [admin]: " username
username=${username:-admin}

# Get password
while true; do
    read -s -p "Choose a password (min 8 chars): " password
    echo ""
    if [ ${#password} -lt 8 ]; then
        echo "   âŒ Password too short, try again"
    else
        break
    fi
done

# Generate secret
echo ""
echo "ðŸ” Generating security secret..."
secret=$(python3 -c "import secrets; print(secrets.token_hex(32))" 2>/dev/null || openssl rand -hex 32)

# Create .env file
cat > .env << EOF
# OpenSentry Command Center Configuration
# Generated by setup.sh on $(date)

# Login credentials
OPENSENTRY_USERNAME=$username
OPENSENTRY_PASSWORD=$password

# Security secret (share this with your Camera Nodes)
OPENSENTRY_SECRET=$secret

# Session timeout in minutes
SESSION_TIMEOUT=30
EOF

echo "âœ… Configuration saved to .env"
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  IMPORTANT: Copy this secret to your Camera Nodes!            â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  OPENSENTRY_SECRET=$secret"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Start the service
echo "ðŸš€ Starting Command Center..."
docker compose up --build -d

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    Setup Complete!                            â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Dashboard:  http://localhost:5000                            â•‘"
echo "â•‘  Username:   $username"
echo "â•‘  Password:   ********                                         â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  Commands:                                                    â•‘"
echo "â•‘    View logs:    docker compose logs -f                       â•‘"
echo "â•‘    Stop:         docker compose down                          â•‘"
echo "â•‘    Restart:      docker compose restart                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
